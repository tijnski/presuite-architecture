# Postal Mail Server Setup

> **Purpose:** Configuration guide for Postal outbound email server
> **Last Updated:** January 16, 2026

---

## Overview

[Postal](https://postal.atech.media/) is an open-source mail delivery platform used by PreMail for reliable outbound email delivery. It provides:

- SMTP relay for outgoing emails
- Delivery tracking and webhooks
- Bounce handling
- Email queuing and retry logic
- Web UI for monitoring

**License:** MIT

---

## Architecture

```
PreMail Flow:
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   PreMail    │────>│    Postal    │────>│  Recipient   │
│   API        │     │   (SMTP)     │     │  Mail Server │
└──────────────┘     └──────────────┘     └──────────────┘
                            │
                            ▼
                     ┌──────────────┐
                     │   Webhooks   │
                     │  (delivery   │
                     │   status)    │
                     └──────────────┘
                            │
                            ▼
                     ┌──────────────┐
                     │   PreMail    │
                     │   Webhook    │
                     │   Handler    │
                     └──────────────┘
```

**Stalwart vs Postal:**
- **Stalwart** - IMAP/SMTP for @premail.site mailboxes (receiving + user sending)
- **Postal** - SMTP relay for bulk/transactional outbound delivery

---

## Installation

### Prerequisites

- Docker & Docker Compose
- Domain with DNS access
- Server with ports 25, 80, 443 available

### 1. Clone Postal

```bash
git clone https://github.com/postalserver/postal /opt/postal
cd /opt/postal
```

### 2. Initialize Configuration

```bash
docker compose run --rm postal initialize
```

This creates:
- `config/postal.yml` - Main configuration
- Database tables
- Initial admin credentials

### 3. Configure DNS

Add these DNS records for your sending domain:

```
# MX Record (for bounce handling)
postal.premail.site    MX    10    postal.premail.site

# A Record
postal.premail.site    A     76.13.1.117

# SPF Record
premail.site           TXT   "v=spf1 include:postal.premail.site ~all"

# DKIM (generated by Postal)
postal._domainkey      TXT   "v=DKIM1; k=rsa; p=<public-key>"

# DMARC
_dmarc.premail.site    TXT   "v=DMARC1; p=quarantine; rua=mailto:dmarc@premail.site"
```

### 4. Start Postal

```bash
docker compose up -d
```

### 5. Create Admin User

```bash
docker compose run --rm postal make-user
```

### 6. Access Web UI

Navigate to `https://postal.premail.site` and log in.

---

## Postal Configuration

### Create Organization

1. Log into Postal web UI
2. Create new organization: `PreMail`

### Create Mail Server

1. Within organization, create server: `premail-production`
2. Note the server UUID

### Generate API Credentials

1. Go to server → Credentials
2. Create new credential with:
   - Name: `premail-api`
   - Type: API
3. Copy the API key

### Configure Domain

1. Go to server → Domains
2. Add domain: `premail.site`
3. Verify DNS records
4. Enable DKIM signing

### Configure Webhooks

1. Go to server → Webhooks
2. Add webhook:
   - URL: `https://premail.site/api/webhooks/postal`
   - Events: All delivery events

---

## Environment Variables

Add to PreMail `.env`:

```bash
# Postal Configuration
POSTAL_API_URL=https://postal.premail.site
POSTAL_API_KEY=<your-api-key>
POSTAL_SERVER=premail-production

# Webhook secret (for verifying webhook signatures)
POSTAL_WEBHOOK_SECRET=<webhook-secret>
```

---

## PreMail Integration

### Sending via Postal

```typescript
// packages/postal/src/client.ts
import { PostalClient } from './postal';

const postal = new PostalClient({
  apiUrl: process.env.POSTAL_API_URL,
  apiKey: process.env.POSTAL_API_KEY,
  server: process.env.POSTAL_SERVER,
});

// Send email
const result = await postal.send({
  to: ['recipient@example.com'],
  from: 'user@premail.site',
  subject: 'Hello',
  html: '<p>Message body</p>',
  headers: {
    'X-PreMail-User-Id': userId,
    'X-PreMail-Message-Id': messageId,
  },
});

// Returns message ID for tracking
console.log(result.messageId);
```

### Webhook Handler

```typescript
// apps/api/src/routes/webhooks.ts
app.post('/webhooks/postal', async (c) => {
  const signature = c.req.header('X-Postal-Signature');
  const body = await c.req.json();

  // Verify signature
  if (!verifyPostalSignature(body, signature)) {
    return c.json({ error: 'Invalid signature' }, 401);
  }

  // Handle events
  switch (body.event) {
    case 'MessageSent':
      await handleSent(body.payload);
      break;
    case 'MessageDelivered':
      await handleDelivered(body.payload);
      break;
    case 'MessageBounced':
      await handleBounce(body.payload);
      break;
    case 'MessageDelayed':
      await handleDelayed(body.payload);
      break;
  }

  return c.json({ received: true });
});
```

---

## Webhook Events

| Event | Description | Action |
|-------|-------------|--------|
| `MessageSent` | Email accepted by Postal | Update status to "sent" |
| `MessageDelivered` | Delivered to recipient server | Update status to "delivered" |
| `MessageBounced` | Delivery failed permanently | Mark as bounced, notify user |
| `MessageDelayed` | Temporary delivery failure | Log, Postal will retry |
| `MessageHeld` | Held for review | Admin notification |

---

## Monitoring

### Postal Web UI

- Dashboard: Delivery stats, queue size
- Messages: Search and view sent emails
- Suppressions: Bounced addresses

### Health Check

```bash
# Check Postal is running
curl -s https://postal.premail.site/health

# Check API
curl -s -H "X-Server-API-Key: $POSTAL_API_KEY" \
  https://postal.premail.site/api/v1/server/message_stats
```

### Logs

```bash
# Postal logs
docker compose logs -f postal

# SMTP logs
docker compose logs -f postal-smtp
```

---

## Troubleshooting

### Email Not Sending

1. Check Postal queue: Web UI → Messages
2. Verify API key is correct
3. Check domain verification status
4. Review SMTP logs

### Webhooks Not Received

1. Verify webhook URL is accessible
2. Check webhook secret matches
3. Review PreMail API logs
4. Test with: `curl -X POST https://premail.site/api/webhooks/postal`

### High Bounce Rate

1. Check SPF/DKIM/DMARC records
2. Review bounce reasons in Postal UI
3. Check if IP is blacklisted
4. Verify sending domain reputation

---

## TODO

- [ ] Run `pnpm install` to link postal package
- [ ] Initialize Postal server (create user, organization, server)
- [ ] Generate API credentials in Postal web UI
- [ ] Configure DNS records (SPF, DKIM, DMARC)
- [ ] Test send flow end-to-end
- [ ] Implement webhook handler in PreMail
- [ ] Verify webhook delivery

---

## Related Documentation

- [PREMAIL.md](../PREMAIL.md) - PreMail service documentation
- [Postal Documentation](https://docs.postalserver.io/) - Official docs
- [architecture/DATA-FLOWS.md](../architecture/DATA-FLOWS.md) - Email flow diagrams
