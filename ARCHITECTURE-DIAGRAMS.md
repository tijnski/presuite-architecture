# PreSuite Architecture Diagrams

> **Date:** January 15, 2026
> **Version:** 1.0

---

## Table of Contents

1. [High-Level System Architecture](#1-high-level-system-architecture)
2. [OAuth SSO Flow](#2-oauth-sso-flow)
3. [PreMail Architecture](#3-premail-architecture)
4. [PreDrive Architecture](#4-predrive-architecture)
5. [PreOffice Architecture](#5-preoffice-architecture)
6. [Infrastructure & Deployment](#6-infrastructure--deployment)
7. [Data Flow Diagrams](#7-data-flow-diagrams)
8. [Security Architecture](#8-security-architecture)

---

## 1. High-Level System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              PreSuite Ecosystem                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│    ┌──────────────┐                                                              │
│    │   Browser    │                                                              │
│    │    (User)    │                                                              │
│    └──────┬───────┘                                                              │
│           │                                                                      │
│           │ HTTPS                                                                │
│           ▼                                                                      │
│    ┌─────────────────────────────────────────────────────────────────────┐      │
│    │                        Cloudflare CDN/DNS                            │      │
│    │         (SSL Termination, DDoS Protection, Caching)                  │      │
│    └─────────────────────────────────────────────────────────────────────┘      │
│           │                                                                      │
│           ▼                                                                      │
│    ┌─────────────────────────────────────────────────────────────────────┐      │
│    │                         Load Balancer / Nginx                        │      │
│    └───┬─────────────┬─────────────┬─────────────┬───────────────────────┘      │
│        │             │             │             │                               │
│        ▼             ▼             ▼             ▼                               │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────┐                        │
│   │PreSuite │  │ PreMail │  │PreDrive │  │  PreOffice  │                        │
│   │   Hub   │  │         │  │         │  │             │                        │
│   │  (IdP)  │  │ (Email) │  │(Storage)│  │   (Docs)    │                        │
│   └────┬────┘  └────┬────┘  └────┬────┘  └──────┬──────┘                        │
│        │            │            │              │                                │
│        └────────────┴─────┬──────┴──────────────┘                                │
│                           │                                                      │
│                           ▼                                                      │
│    ┌─────────────────────────────────────────────────────────────────────┐      │
│    │                      Shared Infrastructure                           │      │
│    │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐    │      │
│    │  │PostgreSQL│  │  Storj   │  │Typesense │  │ Stalwart Mail    │    │      │
│    │  │    DB    │  │(S3 Store)│  │ (Search) │  │(IMAP/SMTP Server)│    │      │
│    │  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘    │      │
│    └─────────────────────────────────────────────────────────────────────┘      │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. OAuth SSO Flow

### 2.1 Authorization Code Flow

```
┌────────────┐                              ┌────────────┐                              ┌────────────┐
│            │                              │            │                              │            │
│   User     │                              │  PreSuite  │                              │  Service   │
│  Browser   │                              │  Hub (IdP) │                              │ (PreMail)  │
│            │                              │            │                              │            │
└─────┬──────┘                              └─────┬──────┘                              └─────┬──────┘
      │                                           │                                           │
      │  1. User clicks "Sign in with PreSuite"   │                                           │
      │ ─────────────────────────────────────────────────────────────────────────────────────>│
      │                                           │                                           │
      │  2. Generate state, redirect to IdP       │                                           │
      │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │
      │                                           │                                           │
      │  3. GET /api/oauth/authorize              │                                           │
      │      ?client_id=premail                   │                                           │
      │      &redirect_uri=.../oauth/callback     │                                           │
      │      &response_type=code                  │                                           │
      │      &scope=openid profile email          │                                           │
      │      &state=random-uuid                   │                                           │
      │ ─────────────────────────────────────────>│                                           │
      │                                           │                                           │
      │  4. Show login form (if not logged in)    │                                           │
      │ <─────────────────────────────────────────│                                           │
      │                                           │                                           │
      │  5. User submits credentials              │                                           │
      │ ─────────────────────────────────────────>│                                           │
      │                                           │                                           │
      │  6. Validate credentials                  │                                           │
      │     Generate authorization code           │                                           │
      │                                           │                                           │
      │  7. Redirect to callback with code        │                                           │
      │ <─────────────────────────────────────────│                                           │
      │     302 Location: .../oauth/callback      │                                           │
      │         ?code=auth-code&state=...         │                                           │
      │                                           │                                           │
      │  8. GET /oauth/callback?code=...&state=...│                                           │
      │ ─────────────────────────────────────────────────────────────────────────────────────>│
      │                                           │                                           │
      │                                           │  9. POST /api/oauth/token                 │
      │                                           │      grant_type=authorization_code        │
      │                                           │      code=auth-code                       │
      │                                           │      client_id + client_secret            │
      │                                           │ <─────────────────────────────────────────│
      │                                           │                                           │
      │                                           │  10. Validate code, generate tokens       │
      │                                           │                                           │
      │                                           │  11. Return tokens                        │
      │                                           │      {access_token, id_token, token_type} │
      │                                           │ ─────────────────────────────────────────>│
      │                                           │                                           │
      │  12. Set session, redirect to app         │                                           │
      │ <─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │
      │                                           │                                           │
      │  13. User is now authenticated            │                                           │
      │ <═════════════════════════════════════════════════════════════════════════════════════│
      │                                           │                                           │
```

### 2.2 Token Structure

```
┌─────────────────────────────────────────────────────────────────┐
│                         ID Token (JWT)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Header (Base64):                                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  {                                                       │   │
│  │    "alg": "HS256",                                       │   │
│  │    "typ": "JWT"                                          │   │
│  │  }                                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           .                                     │
│  Payload (Base64):                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  {                                                       │   │
│  │    "sub": "550e8400-e29b-41d4-a716-446655440000",       │   │
│  │    "org_id": "660e8400-e29b-41d4-a716-446655440000",    │   │
│  │    "email": "user@example.com",                          │   │
│  │    "name": "John Doe",                                   │   │
│  │    "iss": "presuite",                                    │   │
│  │    "aud": "premail",                                     │   │
│  │    "iat": 1736956800,                                    │   │
│  │    "exp": 1736960400                                     │   │
│  │  }                                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                           .                                     │
│  Signature (Base64):                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  HMACSHA256(                                             │   │
│  │    base64UrlEncode(header) + "." +                       │   │
│  │    base64UrlEncode(payload),                             │   │
│  │    JWT_SECRET                                            │   │
│  │  )                                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. PreMail Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              PreMail System                                      │
│                           https://premail.site                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         Frontend (React + Vite)                          │   │
│   │                                                                          │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │   │
│   │  │  Login   │  │  Inbox   │  │ Compose  │  │ Message  │  │ Settings │  │   │
│   │  │  Page    │  │  Page    │  │  Modal   │  │  View    │  │  Page    │  │   │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │   │
│   │       │                                                                  │   │
│   │       ▼                                                                  │   │
│   │  ┌──────────────────────────────────────────────────────────────────┐   │   │
│   │  │                    State Management (Zustand)                     │   │   │
│   │  │   useAuth  │  useMailStore  │  useThreadStore  │  useSettings    │   │   │
│   │  └──────────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│                                        │ HTTP/REST                               │
│                                        ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         Backend (Hono + Bun)                             │   │
│   │                                                                          │   │
│   │  ┌──────────────────────────────────────────────────────────────────┐   │   │
│   │  │                         Middleware                                │   │   │
│   │  │   Auth  │  RateLimiter  │  CORS  │  SecureHeaders  │  Logger     │   │   │
│   │  └──────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                          │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │   │
│   │  │  /auth   │  │/messages │  │ /search  │  │/accounts │  │/webhooks │  │   │
│   │  │  routes  │  │  routes  │  │  routes  │  │  routes  │  │  routes  │  │   │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │   │
│   │       │             │             │             │             │          │   │
│   │       └─────────────┴──────┬──────┴─────────────┴─────────────┘          │   │
│   │                            │                                             │   │
│   │  ┌─────────────────────────┴─────────────────────────────────────────┐  │   │
│   │  │                      Service Layer                                 │  │   │
│   │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │  │   │
│   │  │  │  Threading   │  │  Encryption  │  │    Stalwart Mail         │ │  │   │
│   │  │  │   Engine     │  │    Utils     │  │  (IMAP/SMTP Client)      │ │  │   │
│   │  │  └──────────────┘  └──────────────┘  └──────────────────────────┘ │  │   │
│   │  └───────────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│           ┌────────────────────────────┼────────────────────────────┐           │
│           │                            │                            │           │
│           ▼                            ▼                            ▼           │
│   ┌──────────────┐            ┌──────────────┐            ┌──────────────┐      │
│   │  PostgreSQL  │            │  Typesense   │            │   Stalwart   │      │
│   │   Database   │            │   Search     │            │ Mail Server  │      │
│   │              │            │              │            │              │      │
│   │ • users      │            │ • messages   │            │ • IMAP:993   │      │
│   │ • accounts   │            │   index      │            │ • SMTP:587   │      │
│   │ • threads    │            │              │            │ • JMAP:443   │      │
│   └──────────────┘            └──────────────┘            └──────────────┘      │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.1 Email Threading Algorithm

```
┌─────────────────────────────────────────────────────────────────┐
│                    Email Threading Flow                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   New Email Arrives                                              │
│         │                                                        │
│         ▼                                                        │
│   ┌─────────────┐                                                │
│   │ Parse Email │                                                │
│   │  Headers    │                                                │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │              Extract Threading Identifiers               │   │
│   │                                                          │   │
│   │  • Message-ID: <abc123@example.com>                      │   │
│   │  • In-Reply-To: <xyz789@example.com>                     │   │
│   │  • References: <first@...> <second@...> <third@...>      │   │
│   │  • Subject: "Re: Original Subject"                       │   │
│   └──────────────────────────┬──────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                   Find Existing Thread                   │   │
│   │                                                          │   │
│   │  1. Match by In-Reply-To header                          │   │
│   │  2. Match by References header                           │   │
│   │  3. Match by normalized subject + participants           │   │
│   └──────────────────────────┬──────────────────────────────┘   │
│                              │                                   │
│              ┌───────────────┴───────────────┐                   │
│              │                               │                   │
│              ▼                               ▼                   │
│   ┌──────────────────┐            ┌──────────────────┐          │
│   │  Thread Found    │            │  No Thread Found │          │
│   │                  │            │                  │          │
│   │  Add message to  │            │  Create new      │          │
│   │  existing thread │            │  thread          │          │
│   └──────────────────┘            └──────────────────┘          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. PreDrive Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              PreDrive System                                     │
│                          https://predrive.eu                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         Frontend (React + Vite)                          │   │
│   │                                                                          │   │
│   │  ┌────────────────────────────────────────────────────────────────────┐ │   │
│   │  │                        File Browser UI                              │ │   │
│   │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐   │ │   │
│   │  │  │ Toolbar  │  │ Sidebar  │  │ FileList │  │  Preview Panel   │   │ │   │
│   │  │  │          │  │ (Tree)   │  │ (Grid/   │  │  (Documents,     │   │ │   │
│   │  │  │ Upload   │  │          │  │  List)   │  │   Images, etc)   │   │ │   │
│   │  │  │ NewFolder│  │          │  │          │  │                  │   │ │   │
│   │  │  └──────────┘  └──────────┘  └──────────┘  └──────────────────┘   │ │   │
│   │  └────────────────────────────────────────────────────────────────────┘ │   │
│   │                                                                          │   │
│   │  ┌────────────────────────────────────────────────────────────────────┐ │   │
│   │  │                    State & Hooks                                    │ │   │
│   │  │   useAuth │ useNodes │ useUpload │ useShare │ usePermissions       │ │   │
│   │  └────────────────────────────────────────────────────────────────────┘ │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│                                        │ HTTP/REST                               │
│                                        ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         Backend (Hono + Bun)                             │   │
│   │                                                                          │   │
│   │  ┌──────────────────────────────────────────────────────────────────┐   │   │
│   │  │                         Middleware                                │   │   │
│   │  │   JWT Auth │ CORS │ Request Logger │ Error Handler                │   │   │
│   │  └──────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                          │   │
│   │  ┌────────────────────────────────────────────────────────────────────┐ │   │
│   │  │                          API Routes                                 │ │   │
│   │  │                                                                     │ │   │
│   │  │  /api/nodes          - CRUD operations on files/folders            │ │   │
│   │  │  /api/nodes/:id/content - Upload/download file content             │ │   │
│   │  │  /api/shares         - Public/private share management             │ │   │
│   │  │  /api/permissions    - Access control management                   │ │   │
│   │  │  /api/trash          - Soft delete and restore                     │ │   │
│   │  │  /wopi/files/:id     - WOPI protocol for PreOffice                 │ │   │
│   │  │                                                                     │ │   │
│   │  └────────────────────────────────────────────────────────────────────┘ │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│           ┌────────────────────────────┴────────────────────────────┐           │
│           │                                                         │           │
│           ▼                                                         ▼           │
│   ┌────────────────────┐                                 ┌────────────────────┐ │
│   │    PostgreSQL      │                                 │       Storj        │ │
│   │     Database       │                                 │   (S3-Compatible)  │ │
│   │                    │                                 │                    │ │
│   │  ┌──────────────┐  │                                 │  ┌──────────────┐  │ │
│   │  │    nodes     │  │                                 │  │   Buckets    │  │ │
│   │  │  (metadata)  │  │                                 │  │              │  │ │
│   │  │              │  │      Presigned URLs             │  │  predrive-   │  │ │
│   │  │ • id         │  │  ◄──────────────────────────►   │  │  files       │  │ │
│   │  │ • name       │  │                                 │  │              │  │ │
│   │  │ • type       │  │                                 │  │  (encrypted  │  │ │
│   │  │ • parentId   │  │                                 │  │   at rest)   │  │ │
│   │  │ • orgId      │  │                                 │  │              │  │ │
│   │  │ • storageKey │  │                                 │  └──────────────┘  │ │
│   │  │ • size       │  │                                 │                    │ │
│   │  │ • mimeType   │  │                                 └────────────────────┘ │
│   │  └──────────────┘  │                                                        │
│   │                    │                                                        │
│   │  ┌──────────────┐  │                                                        │
│   │  │ permissions  │  │                                                        │
│   │  │              │  │                                                        │
│   │  │ • nodeId     │  │                                                        │
│   │  │ • principal  │  │                                                        │
│   │  │ • role       │  │                                                        │
│   │  │ • inherited  │  │                                                        │
│   │  └──────────────┘  │                                                        │
│   │                    │                                                        │
│   │  ┌──────────────┐  │                                                        │
│   │  │   shares     │  │                                                        │
│   │  │              │  │                                                        │
│   │  │ • nodeId     │  │                                                        │
│   │  │ • token      │  │                                                        │
│   │  │ • expiresAt  │  │                                                        │
│   │  │ • password   │  │                                                        │
│   │  └──────────────┘  │                                                        │
│   └────────────────────┘                                                        │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.1 File Upload Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      File Upload Flow                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Browser                    API                     Storj       │
│      │                        │                        │         │
│      │  1. POST /api/nodes    │                        │         │
│      │     {name, parentId,   │                        │         │
│      │      type: "file"}     │                        │         │
│      │ ──────────────────────>│                        │         │
│      │                        │                        │         │
│      │                        │  2. Create node in DB  │         │
│      │                        │     Generate storageKey│         │
│      │                        │                        │         │
│      │                        │  3. Generate presigned │         │
│      │                        │     PUT URL            │         │
│      │                        │ ──────────────────────>│         │
│      │                        │                        │         │
│      │                        │ <──────────────────────│         │
│      │                        │     Presigned URL      │         │
│      │                        │                        │         │
│      │  4. Return uploadUrl   │                        │         │
│      │ <──────────────────────│                        │         │
│      │                        │                        │         │
│      │  5. PUT file directly  │                        │         │
│      │     to Storj           │                        │         │
│      │ ───────────────────────────────────────────────>│         │
│      │                        │                        │         │
│      │  6. Upload complete    │                        │         │
│      │ <───────────────────────────────────────────────│         │
│      │                        │                        │         │
│      │  7. PATCH /api/nodes/:id                        │         │
│      │     {status: "ready"}  │                        │         │
│      │ ──────────────────────>│                        │         │
│      │                        │                        │         │
│      │                        │  8. Update node status │         │
│      │                        │                        │         │
│      │  9. Success response   │                        │         │
│      │ <──────────────────────│                        │         │
│      │                        │                        │         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. PreOffice Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              PreOffice System                                    │
│                          https://preoffice.site                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                              Nginx Proxy                                 │   │
│   │                                                                          │   │
│   │   /              → Static landing page                                   │   │
│   │   /browser/*     → Collabora static files                                │   │
│   │   /cool/*        → Collabora WebSocket                                   │   │
│   │   /wopi/*        → WOPI Server                                           │   │
│   │   /api/*         → API Server                                            │   │
│   │   /oauth/callback → OAuth callback (landing page)                        │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                    │                                │                            │
│                    ▼                                ▼                            │
│   ┌────────────────────────────┐    ┌────────────────────────────────────────┐  │
│   │      WOPI Server (Bun)     │    │         Collabora Online              │  │
│   │                            │    │                                        │  │
│   │  ┌──────────────────────┐  │    │  ┌──────────────────────────────────┐ │  │
│   │  │    WOPI Endpoints    │  │    │  │        Document Editor           │ │  │
│   │  │                      │  │    │  │                                  │ │  │
│   │  │ CheckFileInfo        │  │    │  │  • Writer (Documents)            │ │  │
│   │  │ GetFile              │◄─┼────┼─►│  • Calc (Spreadsheets)           │ │  │
│   │  │ PutFile              │  │    │  │  • Impress (Presentations)       │ │  │
│   │  │ PutRelativeFile      │  │    │  │                                  │ │  │
│   │  │ Lock/Unlock          │  │    │  │  Real-time collaboration         │ │  │
│   │  │                      │  │    │  │  via WebSocket                   │ │  │
│   │  └──────────────────────┘  │    │  │                                  │ │  │
│   │                            │    │  └──────────────────────────────────┘ │  │
│   │  ┌──────────────────────┐  │    │                                        │  │
│   │  │    API Endpoints     │  │    │  Configuration:                        │  │
│   │  │                      │  │    │  • server_name: preoffice.site         │  │
│   │  │ POST /api/open       │  │    │  • ssl.enable: false (nginx handles)   │  │
│   │  │   → Generate WOPI URL│  │    │  • storage.wopi.host: wopi:8080        │  │
│   │  │                      │  │    │                                        │  │
│   │  └──────────────────────┘  │    └────────────────────────────────────────┘  │
│   │                            │                                                 │
│   │  ┌──────────────────────┐  │                                                 │
│   │  │   Storage Backends   │  │                                                 │
│   │  │                      │  │                                                 │
│   │  │  • Local filesystem  │  │                                                 │
│   │  │  • PreDrive (WOPI)   │◄─┼─────────────────────────────────────────────┐  │
│   │  │                      │  │                                             │  │
│   │  └──────────────────────┘  │                                             │  │
│   └────────────────────────────┘                                             │  │
│                                                                              │  │
└──────────────────────────────────────────────────────────────────────────────┼──┘
                                                                               │
                                                                               │
                          ┌────────────────────────────────────────────────────┘
                          │
                          ▼
           ┌────────────────────────────┐
           │         PreDrive           │
           │                            │
           │   WOPI Integration:        │
           │   • CheckFileInfo          │
           │   • GetFile                │
           │   • PutFile                │
           │                            │
           │   Files stored in Storj    │
           └────────────────────────────┘
```

### 5.1 WOPI Protocol Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      WOPI Document Open Flow                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Browser          PreOffice         Collabora        PreDrive    │
│     │                │                  │                │       │
│     │ 1. Open file   │                  │                │       │
│     │   from Drive   │                  │                │       │
│     │───────────────>│                  │                │       │
│     │                │                  │                │       │
│     │                │ 2. POST /api/open                 │       │
│     │                │    {fileId, accessToken}          │       │
│     │                │──────────────────────────────────>│       │
│     │                │                  │                │       │
│     │                │                  │  3. Validate   │       │
│     │                │                  │     token      │       │
│     │                │                  │                │       │
│     │                │ 4. Return WOPI URL                │       │
│     │                │<──────────────────────────────────│       │
│     │                │                  │                │       │
│     │ 5. Redirect to │                  │                │       │
│     │    Collabora   │                  │                │       │
│     │    with WOPI   │                  │                │       │
│     │<───────────────│                  │                │       │
│     │                │                  │                │       │
│     │ 6. Load editor │                  │                │       │
│     │───────────────────────────────────>│                │       │
│     │                │                  │                │       │
│     │                │                  │ 7. CheckFileInfo       │
│     │                │                  │───────────────>│       │
│     │                │                  │                │       │
│     │                │                  │ 8. File info   │       │
│     │                │                  │<───────────────│       │
│     │                │                  │                │       │
│     │                │                  │ 9. GetFile     │       │
│     │                │                  │───────────────>│       │
│     │                │                  │                │       │
│     │                │                  │ 10. File data  │       │
│     │                │                  │<───────────────│       │
│     │                │                  │                │       │
│     │ 11. Document   │                  │                │       │
│     │     loaded     │                  │                │       │
│     │<───────────────────────────────────│                │       │
│     │                │                  │                │       │
│     │  [User edits document...]          │                │       │
│     │                │                  │                │       │
│     │                │                  │ 12. PutFile    │       │
│     │                │                  │    (auto-save) │       │
│     │                │                  │───────────────>│       │
│     │                │                  │                │       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. Infrastructure & Deployment

### 6.1 Server Layout

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Infrastructure Overview                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                          Cloudflare                                      │   │
│   │                                                                          │   │
│   │   DNS Records:                                                           │   │
│   │   • presuite.eu    → 76.13.2.221                                         │   │
│   │   • premail.site   → 76.13.1.117                                         │   │
│   │   • predrive.eu  → 76.13.1.110                                         │   │
│   │   • preoffice.site → 76.13.2.220                                         │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│        ┌───────────────────────────────┼───────────────────────────┐            │
│        │                               │                           │            │
│        ▼                               ▼                           ▼            │
│   ┌──────────────┐              ┌──────────────┐            ┌──────────────┐    │
│   │ 76.13.2.221  │              │ 76.13.1.117  │            │ 76.13.1.110  │    │
│   │              │              │              │            │              │    │
│   │  PreSuite    │              │   PreMail    │            │  PreDrive    │    │
│   │    Hub       │              │              │            │              │    │
│   │              │              │ ┌──────────┐ │            │ ┌──────────┐ │    │
│   │ ┌──────────┐ │              │ │  Nginx   │ │            │ │  Docker  │ │    │
│   │ │ PM2      │ │              │ │          │ │            │ │          │ │    │
│   │ │          │ │              │ │ :80/:443 │ │            │ │ api:3000 │ │    │
│   │ │ server.js│ │              │ └────┬─────┘ │            │ │ web:80   │ │    │
│   │ │ :3000    │ │              │      │       │            │ │ db:5432  │ │    │
│   │ └──────────┘ │              │      ▼       │            │ └──────────┘ │    │
│   │              │              │ ┌──────────┐ │            │              │    │
│   │              │              │ │ PM2      │ │            └──────────────┘    │
│   └──────────────┘              │ │          │ │                                │
│                                 │ │ API:3001 │ │            ┌──────────────┐    │
│                                 │ │ Web:/var │ │            │ 76.13.2.220  │    │
│                                 │ │ /www/... │ │            │              │    │
│                                 │ └──────────┘ │            │  PreOffice   │    │
│                                 │              │            │              │    │
│                                 │ ┌──────────┐ │            │ ┌──────────┐ │    │
│                                 │ │PostgreSQL│ │            │ │  Docker  │ │    │
│                                 │ │ :5432    │ │            │ │          │ │    │
│                                 │ └──────────┘ │            │ │nginx:443 │ │    │
│                                 │              │            │ │wopi:8080 │ │    │
│                                 │ ┌──────────┐ │            │ │collabora │ │    │
│                                 │ │Typesense │ │            │ │ :9980    │ │    │
│                                 │ │ :8108    │ │            │ └──────────┘ │    │
│                                 │ └──────────┘ │            │              │    │
│                                 │              │            └──────────────┘    │
│                                 │ ┌──────────┐ │                                │
│                                 │ │Stalwart  │ │                                │
│                                 │ │IMAP:993  │ │                                │
│                                 │ │SMTP:587  │ │                                │
│                                 │ └──────────┘ │                                │
│                                 │              │                                │
│                                 └──────────────┘                                │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                        External Services                                 │   │
│   │                                                                          │   │
│   │   ┌──────────────┐         ┌──────────────┐         ┌──────────────┐    │   │
│   │   │    Storj     │         │   Postal     │         │  Let's       │    │   │
│   │   │  (S3 Store)  │         │ (Outbound    │         │  Encrypt     │    │   │
│   │   │              │         │  Email)      │         │  (SSL Certs) │    │   │
│   │   │ gateway.     │         │              │         │              │    │   │
│   │   │ storjshare.io│         │              │         │              │    │   │
│   │   └──────────────┘         └──────────────┘         └──────────────┘    │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Docker Compose - PreDrive

```
┌─────────────────────────────────────────────────────────────────┐
│                    PreDrive Docker Stack                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                     docker-compose.yml                   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   ┌──────────────────┐  ┌──────────────────┐                    │
│   │      nginx       │  │       api        │                    │
│   │                  │  │                  │                    │
│   │  Port: 80, 443   │  │  Port: 3000      │                    │
│   │                  │  │                  │                    │
│   │  Volumes:        │  │  Depends on:     │                    │
│   │  - ./nginx.conf  │  │  - db            │                    │
│   │  - /certs        │  │                  │                    │
│   │  - /web/dist     │  │  Environment:    │                    │
│   │                  │  │  - DATABASE_URL  │                    │
│   │  Depends on:     │  │  - JWT_SECRET    │                    │
│   │  - api           │  │  - S3_* vars     │                    │
│   └────────┬─────────┘  └────────┬─────────┘                    │
│            │                     │                               │
│            │    internal network │                               │
│            └──────────┬──────────┘                               │
│                       │                                          │
│                       ▼                                          │
│            ┌──────────────────┐                                  │
│            │        db        │                                  │
│            │                  │                                  │
│            │  PostgreSQL 16   │                                  │
│            │  Port: 5432      │                                  │
│            │                  │                                  │
│            │  Volumes:        │                                  │
│            │  - pgdata:/var/  │                                  │
│            │    lib/postgres  │                                  │
│            │                  │                                  │
│            └──────────────────┘                                  │
│                                                                  │
│   Networks:                                                      │
│   └── predrive (bridge)                                          │
│                                                                  │
│   Volumes:                                                       │
│   └── pgdata (persistent)                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 Docker Compose - PreOffice

```
┌─────────────────────────────────────────────────────────────────┐
│                   PreOffice Docker Stack                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                     docker-compose.yml                   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   ┌──────────────────┐                                          │
│   │      nginx       │                                          │
│   │                  │                                          │
│   │  Port: 80, 443   │                                          │
│   │                  │                                          │
│   │  Routes:         │                                          │
│   │  /      → static │                                          │
│   │  /wopi  → wopi   │                                          │
│   │  /cool  → collabora                                         │
│   │  /api   → wopi   │                                          │
│   │                  │                                          │
│   │  Depends on:     │                                          │
│   │  - wopi          │                                          │
│   │  - collabora     │                                          │
│   └────────┬─────────┘                                          │
│            │                                                     │
│            │    internal network                                 │
│   ┌────────┴─────────────────────────┐                          │
│   │                                  │                          │
│   ▼                                  ▼                          │
│   ┌──────────────────┐  ┌──────────────────┐                    │
│   │       wopi       │  │    collabora     │                    │
│   │                  │  │                  │                    │
│   │  Bun + Hono      │  │  Collabora CODE  │                    │
│   │  Port: 8080      │  │  Port: 9980      │                    │
│   │                  │  │                  │                    │
│   │  WOPI Protocol:  │  │  Features:       │                    │
│   │  - CheckFileInfo │  │  - Writer        │                    │
│   │  - GetFile       │  │  - Calc          │                    │
│   │  - PutFile       │  │  - Impress       │                    │
│   │  - Lock/Unlock   │  │                  │                    │
│   │                  │  │  Environment:    │                    │
│   │  Storage:        │  │  - server_name   │                    │
│   │  - Local files   │  │  - aliasgroup1   │                    │
│   │  - PreDrive API  │  │  - extra_params  │                    │
│   │                  │  │                  │                    │
│   └──────────────────┘  └──────────────────┘                    │
│                                                                  │
│   Networks:                                                      │
│   └── preoffice (bridge)                                         │
│                                                                  │
│   Volumes:                                                       │
│   └── wopi-data (WOPI file storage)                              │
│   └── static (Landing page)                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. Data Flow Diagrams

### 7.1 Email Send Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      Email Send Flow                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   User                PreMail              Stalwart    Recipient │
│    │                    │                     │            │     │
│    │  1. Compose email  │                     │            │     │
│    │       & Send       │                     │            │     │
│    │───────────────────>│                     │            │     │
│    │                    │                     │            │     │
│    │                    │  2. POST /messages  │            │     │
│    │                    │     {to, subject,   │            │     │
│    │                    │      body, ...}     │            │     │
│    │                    │                     │            │     │
│    │                    │  3. Connect SMTP    │            │     │
│    │                    │     (port 587/TLS)  │            │     │
│    │                    │────────────────────>│            │     │
│    │                    │                     │            │     │
│    │                    │  4. SMTP AUTH       │            │     │
│    │                    │     (credentials)   │            │     │
│    │                    │────────────────────>│            │     │
│    │                    │                     │            │     │
│    │                    │  5. Send MAIL FROM, │            │     │
│    │                    │     RCPT TO, DATA   │            │     │
│    │                    │────────────────────>│            │     │
│    │                    │                     │            │     │
│    │                    │                     │  6. Queue  │     │
│    │                    │                     │     email  │     │
│    │                    │                     │            │     │
│    │                    │  7. 250 OK          │            │     │
│    │                    │<────────────────────│            │     │
│    │                    │                     │            │     │
│    │  8. Email sent     │                     │  9. SMTP   │     │
│    │     confirmation   │                     │     to MX  │     │
│    │<───────────────────│                     │───────────>│     │
│    │                    │                     │            │     │
│    │                    │                     │            │  10.│
│    │                    │                     │            │Email│
│    │                    │                     │            │deliv│
│    │                    │                     │            │ered │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 Email Receive Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     Email Receive Flow                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Sender     Stalwart     Webhook      PreMail API    Typesense  │
│    │           │            │              │              │      │
│    │  1. SMTP  │            │              │              │      │
│    │   email   │            │              │              │      │
│    │──────────>│            │              │              │      │
│    │           │            │              │              │      │
│    │           │  2. Store  │              │              │      │
│    │           │   in JMAP  │              │              │      │
│    │           │            │              │              │      │
│    │           │  3. POST   │              │              │      │
│    │           │   webhook  │              │              │      │
│    │           │───────────>│              │              │      │
│    │           │            │              │              │      │
│    │           │            │  4. Verify   │              │      │
│    │           │            │    signature │              │      │
│    │           │            │              │              │      │
│    │           │            │  5. Process  │              │      │
│    │           │            │    webhook   │              │      │
│    │           │            │─────────────>│              │      │
│    │           │            │              │              │      │
│    │           │            │              │  6. Fetch    │      │
│    │           │            │              │    email via │      │
│    │           │            │              │    IMAP      │      │
│    │           │            │              │              │      │
│    │           │            │              │  7. Thread   │      │
│    │           │            │              │    message   │      │
│    │           │            │              │              │      │
│    │           │            │              │  8. Index    │      │
│    │           │            │              │─────────────>│      │
│    │           │            │              │              │      │
│    │           │            │              │  9. Push     │      │
│    │           │            │              │ notification │      │
│    │           │            │              │  (if enabled)│      │
│    │           │            │              │              │      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.3 Document Collaboration Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                  Real-time Collaboration Flow                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   User A              Collabora            User B                │
│     │                    │                    │                  │
│     │  1. Open document  │                    │                  │
│     │───────────────────>│                    │                  │
│     │                    │                    │                  │
│     │  2. WebSocket      │                    │                  │
│     │     connection     │                    │                  │
│     │<==================>│                    │                  │
│     │                    │                    │                  │
│     │                    │  3. Open same doc  │                  │
│     │                    │<───────────────────│                  │
│     │                    │                    │                  │
│     │                    │  4. WebSocket      │                  │
│     │                    │     connection     │                  │
│     │                    │<==================>│                  │
│     │                    │                    │                  │
│     │  5. Type "Hello"   │                    │                  │
│     │───────────────────>│                    │                  │
│     │                    │                    │                  │
│     │                    │  6. Broadcast      │                  │
│     │                    │     operation      │                  │
│     │                    │───────────────────>│                  │
│     │                    │                    │                  │
│     │                    │                    │  7. See "Hello"  │
│     │                    │                    │     appear       │
│     │                    │                    │                  │
│     │                    │  8. Type "World"   │                  │
│     │                    │<───────────────────│                  │
│     │                    │                    │                  │
│     │  9. Broadcast      │                    │                  │
│     │     operation      │                    │                  │
│     │<───────────────────│                    │                  │
│     │                    │                    │                  │
│     │  10. See "World"   │                    │                  │
│     │      appear        │                    │                  │
│     │                    │                    │                  │
│     │                    │  11. Auto-save     │                  │
│     │                    │      (PutFile)     │                  │
│     │                    │                    │                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. Security Architecture

### 8.1 Authentication Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Security Architecture                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    Authentication                        │   │
│   │                                                          │   │
│   │   ┌─────────────┐    ┌─────────────┐    ┌────────────┐  │   │
│   │   │   OAuth     │    │   Basic     │    │   JWT      │  │   │
│   │   │   SSO       │    │   Auth      │    │  Bearer    │  │   │
│   │   │             │    │             │    │            │  │   │
│   │   │ PreSuite    │    │ Email +     │    │ API calls  │  │   │
│   │   │ Hub as IdP  │    │ Password    │    │ after auth │  │   │
│   │   └─────────────┘    └─────────────┘    └────────────┘  │   │
│   │         │                  │                  │          │   │
│   │         └──────────────────┴──────────────────┘          │   │
│   │                            │                             │   │
│   │                            ▼                             │   │
│   │              ┌─────────────────────────┐                 │   │
│   │              │   JWT Token Issued      │                 │   │
│   │              │                         │                 │   │
│   │              │  Claims:                │                 │   │
│   │              │  • sub (user ID)        │                 │   │
│   │              │  • org_id               │                 │   │
│   │              │  • email                │                 │   │
│   │              │  • name                 │                 │   │
│   │              │  • exp (1 hour)         │                 │   │
│   │              └─────────────────────────┘                 │   │
│   │                                                          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    Authorization                         │   │
│   │                                                          │   │
│   │   ┌───────────────────────────────────────────────────┐ │   │
│   │   │              Role-Based Access Control             │ │   │
│   │   │                                                    │ │   │
│   │   │   ┌─────────┐  ┌─────────┐  ┌─────────┐          │ │   │
│   │   │   │  Owner  │  │ Editor  │  │ Viewer  │          │ │   │
│   │   │   │         │  │         │  │         │          │ │   │
│   │   │   │ • Read  │  │ • Read  │  │ • Read  │          │ │   │
│   │   │   │ • Write │  │ • Write │  │         │          │ │   │
│   │   │   │ • Delete│  │         │  │         │          │ │   │
│   │   │   │ • Share │  │         │  │         │          │ │   │
│   │   │   │ • Admin │  │         │  │         │          │ │   │
│   │   │   └─────────┘  └─────────┘  └─────────┘          │ │   │
│   │   │                                                    │ │   │
│   │   └───────────────────────────────────────────────────┘ │   │
│   │                                                          │   │
│   │   Permission Inheritance:                                │   │
│   │   Root Folder → Subfolder → File                         │   │
│   │        ↓            ↓          ↓                         │   │
│   │     owner        inherited   inherited                   │   │
│   │                                                          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                  Security Measures                       │   │
│   │                                                          │   │
│   │  Transport:           Application:         Data:         │   │
│   │  • TLS 1.2/1.3       • Rate limiting      • Encryption   │   │
│   │  • HTTPS only        • CSRF protection    • at rest      │   │
│   │  • HSTS headers      • XSS prevention     • Bcrypt       │   │
│   │                      • Input validation    • passwords   │   │
│   │                      • Output encoding     • S3 signed   │   │
│   │                      • Security headers    • URLs        │   │
│   │                                                          │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 8.2 Request Flow Through Security Layers

```
┌─────────────────────────────────────────────────────────────────┐
│              Request Flow Through Security Layers                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Incoming Request                                               │
│         │                                                        │
│         ▼                                                        │
│   ┌─────────────┐                                                │
│   │ Cloudflare  │  DDoS Protection, WAF, SSL Termination         │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────┐                                                │
│   │   Nginx     │  Reverse Proxy, Additional SSL, Rate Limit     │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────┐                                                │
│   │   CORS      │  Cross-Origin Request Validation               │
│   │ Middleware  │                                                │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────┐                                                │
│   │  Security   │  X-Frame-Options, CSP, XSS Protection          │
│   │  Headers    │                                                │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────┐                                                │
│   │Rate Limiter │  5 auth attempts / 15 min                      │
│   │             │  100 API requests / min                        │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────┐                                                │
│   │    Auth     │  JWT Verification, User Context                │
│   │ Middleware  │                                                │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────┐                                                │
│   │  Input      │  Zod Schema Validation, Sanitization           │
│   │ Validation  │                                                │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────┐                                                │
│   │   Route     │  Business Logic                                │
│   │  Handler    │                                                │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   Response                                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## Appendix: Quick Reference

### Service URLs

| Service | Production URL | Server IP |
|---------|---------------|-----------|
| PreSuite Hub | https://presuite.eu | 76.13.2.221 |
| PreMail | https://premail.site | 76.13.1.117 |
| PreDrive | https://predrive.eu | 76.13.1.110 |
| PreOffice | https://preoffice.site | 76.13.2.220 |

### Ports

| Service | Port | Protocol |
|---------|------|----------|
| HTTPS | 443 | TLS |
| HTTP (redirect) | 80 | TCP |
| PostgreSQL | 5432 | TCP |
| Typesense | 8108 | HTTP |
| IMAP | 993 | TLS |
| SMTP | 587 | STARTTLS |
| Collabora | 9980 | HTTP |
| WOPI | 8080 | HTTP |

### Technology Stack

| Layer | Technology |
|-------|------------|
| Frontend | React, Vite, TypeScript, TailwindCSS |
| Backend | Bun, Hono, TypeScript |
| Database | PostgreSQL 16, Drizzle ORM |
| Search | Typesense |
| Storage | Storj (S3-compatible) |
| Mail Server | Stalwart Mail |
| Documents | Collabora Online (CODE) |
| Process Manager | PM2, Docker |
| Reverse Proxy | Nginx, Cloudflare |
