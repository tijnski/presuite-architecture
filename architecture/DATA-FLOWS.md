# Data Flow Diagrams

## Email Send Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      Email Send Flow                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   User                PreMail              Stalwart    Recipient │
│    │                    │                     │            │     │
│    │  1. Compose email  │                     │            │     │
│    │       & Send       │                     │            │     │
│    │───────────────────>│                     │            │     │
│    │                    │                     │            │     │
│    │                    │  2. POST /messages  │            │     │
│    │                    │     {to, subject,   │            │     │
│    │                    │      body, ...}     │            │     │
│    │                    │                     │            │     │
│    │                    │  3. Connect SMTP    │            │     │
│    │                    │     (port 587/TLS)  │            │     │
│    │                    │────────────────────>│            │     │
│    │                    │                     │            │     │
│    │                    │  4. SMTP AUTH       │            │     │
│    │                    │     (credentials)   │            │     │
│    │                    │────────────────────>│            │     │
│    │                    │                     │            │     │
│    │                    │  5. Send MAIL FROM, │            │     │
│    │                    │     RCPT TO, DATA   │            │     │
│    │                    │────────────────────>│            │     │
│    │                    │                     │            │     │
│    │                    │                     │  6. Queue  │     │
│    │                    │                     │     email  │     │
│    │                    │                     │            │     │
│    │                    │  7. 250 OK          │            │     │
│    │                    │<────────────────────│            │     │
│    │                    │                     │            │     │
│    │  8. Email sent     │                     │  9. SMTP   │     │
│    │     confirmation   │                     │     to MX  │     │
│    │<───────────────────│                     │───────────>│     │
│    │                    │                     │            │     │
│    │                    │                     │            │  10.│
│    │                    │                     │            │Email│
│    │                    │                     │            │deliv│
│    │                    │                     │            │ered │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Email Receive Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                     Email Receive Flow                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Sender     Stalwart     Webhook      PreMail API    Typesense  │
│    │           │            │              │              │      │
│    │  1. SMTP  │            │              │              │      │
│    │   email   │            │              │              │      │
│    │──────────>│            │              │              │      │
│    │           │            │              │              │      │
│    │           │  2. Store  │              │              │      │
│    │           │   in JMAP  │              │              │      │
│    │           │            │              │              │      │
│    │           │  3. POST   │              │              │      │
│    │           │   webhook  │              │              │      │
│    │           │───────────>│              │              │      │
│    │           │            │              │              │      │
│    │           │            │  4. Verify   │              │      │
│    │           │            │    signature │              │      │
│    │           │            │              │              │      │
│    │           │            │  5. Process  │              │      │
│    │           │            │    webhook   │              │      │
│    │           │            │─────────────>│              │      │
│    │           │            │              │              │      │
│    │           │            │              │  6. Fetch    │      │
│    │           │            │              │    email via │      │
│    │           │            │              │    IMAP      │      │
│    │           │            │              │              │      │
│    │           │            │              │  7. Thread   │      │
│    │           │            │              │    message   │      │
│    │           │            │              │              │      │
│    │           │            │              │  8. Index    │      │
│    │           │            │              │─────────────>│      │
│    │           │            │              │              │      │
│    │           │            │              │  9. Push     │      │
│    │           │            │              │ notification │      │
│    │           │            │              │  (if enabled)│      │
│    │           │            │              │              │      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Document Collaboration Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                  Real-time Collaboration Flow                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   User A              Collabora            User B                │
│     │                    │                    │                  │
│     │  1. Open document  │                    │                  │
│     │───────────────────>│                    │                  │
│     │                    │                    │                  │
│     │  2. WebSocket      │                    │                  │
│     │     connection     │                    │                  │
│     │<==================>│                    │                  │
│     │                    │                    │                  │
│     │                    │  3. Open same doc  │                  │
│     │                    │<───────────────────│                  │
│     │                    │                    │                  │
│     │                    │  4. WebSocket      │                  │
│     │                    │     connection     │                  │
│     │                    │<==================>│                  │
│     │                    │                    │                  │
│     │  5. Type "Hello"   │                    │                  │
│     │───────────────────>│                    │                  │
│     │                    │                    │                  │
│     │                    │  6. Broadcast      │                  │
│     │                    │     operation      │                  │
│     │                    │───────────────────>│                  │
│     │                    │                    │                  │
│     │                    │                    │  7. See "Hello"  │
│     │                    │                    │     appear       │
│     │                    │                    │                  │
│     │                    │  8. Type "World"   │                  │
│     │                    │<───────────────────│                  │
│     │                    │                    │                  │
│     │  9. Broadcast      │                    │                  │
│     │     operation      │                    │                  │
│     │<───────────────────│                    │                  │
│     │                    │                    │                  │
│     │  10. See "World"   │                    │                  │
│     │      appear        │                    │                  │
│     │                    │                    │                  │
│     │                    │  11. Auto-save     │                  │
│     │                    │      (PutFile)     │                  │
│     │                    │                    │                  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## File Upload Flow

See [PREDRIVE.md](PREDRIVE.md#file-upload-flow) for the complete file upload sequence diagram.
