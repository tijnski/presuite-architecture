# PreMail Architecture

**URL:** https://premail.site
**Server:** 76.13.1.117

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              PreMail System                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         Frontend (React + Vite)                          │   │
│   │                                                                          │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │   │
│   │  │  Login   │  │  Inbox   │  │ Compose  │  │ Message  │  │ Settings │  │   │
│   │  │  Page    │  │  Page    │  │  Modal   │  │  View    │  │  Page    │  │   │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │   │
│   │       │                                                                  │   │
│   │       ▼                                                                  │   │
│   │  ┌──────────────────────────────────────────────────────────────────┐   │   │
│   │  │                    State Management (Zustand)                     │   │   │
│   │  │   useAuth  │  useMailStore  │  useThreadStore  │  useSettings    │   │   │
│   │  └──────────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│                                        │ HTTP/REST                               │
│                                        ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         Backend (Hono + Bun)                             │   │
│   │                                                                          │   │
│   │  ┌──────────────────────────────────────────────────────────────────┐   │   │
│   │  │                         Middleware                                │   │   │
│   │  │   Auth  │  RateLimiter  │  CORS  │  SecureHeaders  │  Logger     │   │   │
│   │  └──────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                          │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │   │
│   │  │  /auth   │  │/messages │  │ /search  │  │/accounts │  │/webhooks │  │   │
│   │  │  routes  │  │  routes  │  │  routes  │  │  routes  │  │  routes  │  │   │
│   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │   │
│   │       │             │             │             │             │          │   │
│   │       └─────────────┴──────┬──────┴─────────────┴─────────────┘          │   │
│   │                            │                                             │   │
│   │  ┌─────────────────────────┴─────────────────────────────────────────┐  │   │
│   │  │                      Service Layer                                 │  │   │
│   │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │  │   │
│   │  │  │  Threading   │  │  Encryption  │  │    Stalwart Mail         │ │  │   │
│   │  │  │   Engine     │  │    Utils     │  │  (IMAP/SMTP Client)      │ │  │   │
│   │  │  └──────────────┘  └──────────────┘  └──────────────────────────┘ │  │   │
│   │  └───────────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│           ┌────────────────────────────┼────────────────────────────┐           │
│           │                            │                            │           │
│           ▼                            ▼                            ▼           │
│   ┌──────────────┐            ┌──────────────┐            ┌──────────────┐      │
│   │  PostgreSQL  │            │  Typesense   │            │   Stalwart   │      │
│   │   Database   │            │   Search     │            │ Mail Server  │      │
│   │              │            │              │            │              │      │
│   │ • users      │            │ • messages   │            │ • IMAP:993   │      │
│   │ • accounts   │            │   index      │            │ • SMTP:587   │      │
│   │ • threads    │            │              │            │ • JMAP:443   │      │
│   └──────────────┘            └──────────────┘            └──────────────┘      │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Email Threading Algorithm

```
┌─────────────────────────────────────────────────────────────────┐
│                    Email Threading Flow                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   New Email Arrives                                              │
│         │                                                        │
│         ▼                                                        │
│   ┌─────────────┐                                                │
│   │ Parse Email │                                                │
│   │  Headers    │                                                │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │              Extract Threading Identifiers               │   │
│   │                                                          │   │
│   │  • Message-ID: <abc123@example.com>                      │   │
│   │  • In-Reply-To: <xyz789@example.com>                     │   │
│   │  • References: <first@...> <second@...> <third@...>      │   │
│   │  • Subject: "Re: Original Subject"                       │   │
│   └──────────────────────────┬──────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                   Find Existing Thread                   │   │
│   │                                                          │   │
│   │  1. Match by In-Reply-To header                          │   │
│   │  2. Match by References header                           │   │
│   │  3. Match by normalized subject + participants           │   │
│   └──────────────────────────┬──────────────────────────────┘   │
│                              │                                   │
│              ┌───────────────┴───────────────┐                   │
│              │                               │                   │
│              ▼                               ▼                   │
│   ┌──────────────────┐            ┌──────────────────┐          │
│   │  Thread Found    │            │  No Thread Found │          │
│   │                  │            │                  │          │
│   │  Add message to  │            │  Create new      │          │
│   │  existing thread │            │  thread          │          │
│   └──────────────────┘            └──────────────────┘          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Key Components

| Component | Technology | Purpose |
|-----------|------------|---------|
| Frontend | React + Vite | Web UI |
| Backend | Hono + Bun | API server |
| Database | PostgreSQL | User/account data |
| Search | Typesense | Full-text search |
| Mail Server | Stalwart | IMAP/SMTP/JMAP |
