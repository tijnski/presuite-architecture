# Infrastructure & Deployment

## Server Layout

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Infrastructure Overview                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                          Cloudflare                                      │   │
│   │                                                                          │   │
│   │   DNS Records:                                                           │   │
│   │   • presuite.eu    → 76.13.2.221                                         │   │
│   │   • premail.site   → 76.13.1.117                                         │   │
│   │   • predrive.eu    → 76.13.1.110                                         │   │
│   │   • preoffice.site → 76.13.2.220                                         │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                         │
│        ┌───────────────────────────────┼───────────────────────────┐            │
│        │                               │                           │            │
│        ▼                               ▼                           ▼            │
│   ┌──────────────┐              ┌──────────────┐            ┌──────────────┐    │
│   │ 76.13.2.221  │              │ 76.13.1.117  │            │ 76.13.1.110  │    │
│   │              │              │              │            │              │    │
│   │  PreSuite    │              │   PreMail    │            │  PreDrive    │    │
│   │    Hub       │              │              │            │              │    │
│   │              │              │ ┌──────────┐ │            │ ┌──────────┐ │    │
│   │ ┌──────────┐ │              │ │  Nginx   │ │            │ │  Docker  │ │    │
│   │ │ PM2      │ │              │ │          │ │            │ │          │ │    │
│   │ │          │ │              │ │ :80/:443 │ │            │ │ api:3000 │ │    │
│   │ │ server.js│ │              │ └────┬─────┘ │            │ │ web:80   │ │    │
│   │ │ :3000    │ │              │      │       │            │ │ db:5432  │ │    │
│   │ └──────────┘ │              │      ▼       │            │ └──────────┘ │    │
│   │              │              │ ┌──────────┐ │            │              │    │
│   │              │              │ │ PM2      │ │            └──────────────┘    │
│   └──────────────┘              │ │          │ │                                │
│                                 │ │ API:3001 │ │            ┌──────────────┐    │
│                                 │ │ Web:/var │ │            │ 76.13.2.220  │    │
│                                 │ │ /www/... │ │            │              │    │
│                                 │ └──────────┘ │            │  PreOffice   │    │
│                                 │              │            │              │    │
│                                 │ ┌──────────┐ │            │ ┌──────────┐ │    │
│                                 │ │PostgreSQL│ │            │ │  Docker  │ │    │
│                                 │ │ :5432    │ │            │ │          │ │    │
│                                 │ └──────────┘ │            │ │nginx:443 │ │    │
│                                 │              │            │ │wopi:8080 │ │    │
│                                 │ ┌──────────┐ │            │ │collabora │ │    │
│                                 │ │Typesense │ │            │ │ :9980    │ │    │
│                                 │ │ :8108    │ │            │ └──────────┘ │    │
│                                 │ └──────────┘ │            │              │    │
│                                 │              │            └──────────────┘    │
│                                 │ ┌──────────┐ │                                │
│                                 │ │Stalwart  │ │                                │
│                                 │ │IMAP:993  │ │                                │
│                                 │ │SMTP:587  │ │                                │
│                                 │ └──────────┘ │                                │
│                                 │              │                                │
│                                 └──────────────┘                                │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                        External Services                                 │   │
│   │                                                                          │   │
│   │   ┌──────────────┐         ┌──────────────┐         ┌──────────────┐    │   │
│   │   │    Storj     │         │   Postal     │         │  Let's       │    │   │
│   │   │  (S3 Store)  │         │ (Outbound    │         │  Encrypt     │    │   │
│   │   │              │         │  Email)      │         │  (SSL Certs) │    │   │
│   │   └──────────────┘         └──────────────┘         └──────────────┘    │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## Docker Compose - PreDrive

```
┌─────────────────────────────────────────────────────────────────┐
│                    PreDrive Docker Stack                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌──────────────────┐  ┌──────────────────┐                    │
│   │      nginx       │  │       api        │                    │
│   │                  │  │                  │                    │
│   │  Port: 80, 443   │  │  Port: 3000      │                    │
│   │                  │  │                  │                    │
│   │  Volumes:        │  │  Depends on:     │                    │
│   │  - ./nginx.conf  │  │  - db            │                    │
│   │  - /certs        │  │                  │                    │
│   │  - /web/dist     │  │  Environment:    │                    │
│   │                  │  │  - DATABASE_URL  │                    │
│   │  Depends on:     │  │  - JWT_SECRET    │                    │
│   │  - api           │  │  - S3_* vars     │                    │
│   └────────┬─────────┘  └────────┬─────────┘                    │
│            │                     │                               │
│            │    internal network │                               │
│            └──────────┬──────────┘                               │
│                       │                                          │
│                       ▼                                          │
│            ┌──────────────────┐                                  │
│            │        db        │                                  │
│            │                  │                                  │
│            │  PostgreSQL 16   │                                  │
│            │  Port: 5432      │                                  │
│            │                  │                                  │
│            │  Volumes:        │                                  │
│            │  - pgdata:/var/  │                                  │
│            │    lib/postgres  │                                  │
│            │                  │                                  │
│            └──────────────────┘                                  │
│                                                                  │
│   Networks: predrive (bridge)                                    │
│   Volumes: pgdata (persistent)                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Docker Compose - PreOffice

```
┌─────────────────────────────────────────────────────────────────┐
│                   PreOffice Docker Stack                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌──────────────────┐                                          │
│   │      nginx       │                                          │
│   │                  │                                          │
│   │  Port: 80, 443   │                                          │
│   │                  │                                          │
│   │  Routes:         │                                          │
│   │  /      → static │                                          │
│   │  /wopi  → wopi   │                                          │
│   │  /cool  → collabora                                         │
│   │  /api   → wopi   │                                          │
│   │                  │                                          │
│   │  Depends on:     │                                          │
│   │  - wopi          │                                          │
│   │  - collabora     │                                          │
│   └────────┬─────────┘                                          │
│            │                                                     │
│            │    internal network                                 │
│   ┌────────┴─────────────────────────┐                          │
│   │                                  │                          │
│   ▼                                  ▼                          │
│   ┌──────────────────┐  ┌──────────────────┐                    │
│   │       wopi       │  │    collabora     │                    │
│   │                  │  │                  │                    │
│   │  Bun + Hono      │  │  Collabora CODE  │                    │
│   │  Port: 8080      │  │  Port: 9980      │                    │
│   │                  │  │                  │                    │
│   │  WOPI Protocol:  │  │  Features:       │                    │
│   │  - CheckFileInfo │  │  - Writer        │                    │
│   │  - GetFile       │  │  - Calc          │                    │
│   │  - PutFile       │  │  - Impress       │                    │
│   │  - Lock/Unlock   │  │                  │                    │
│   │                  │  │  Environment:    │                    │
│   │  Storage:        │  │  - server_name   │                    │
│   │  - Local files   │  │  - aliasgroup1   │                    │
│   │  - PreDrive API  │  │  - extra_params  │                    │
│   │                  │  │                  │                    │
│   └──────────────────┘  └──────────────────┘                    │
│                                                                  │
│   Networks: preoffice (bridge)                                   │
│   Volumes: wopi-data, static                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Server Summary

| Server | IP | Services | Process Manager |
|--------|-----|----------|-----------------|
| PreSuite Hub | 76.13.2.221 | Hub, PreSocial | PM2 |
| PreMail | 76.13.1.117 | API, Web, PostgreSQL, Typesense, Stalwart | PM2 |
| PreDrive | 76.13.1.110 | API, Web, PostgreSQL | Docker |
| PreOffice | 76.13.2.220 | Nginx, WOPI, Collabora | Docker |
